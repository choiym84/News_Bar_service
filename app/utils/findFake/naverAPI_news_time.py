import requests
from bs4 import BeautifulSoup
from datetime import datetime
import os
from dotenv import load_dotenv
import re

# âœ… í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()
CLIENT_ID = os.getenv("API_KEY")
CLIENT_SECRET = os.getenv("API_SECRET")

def í‚¤ì›Œë“œ_AND_ì¿¼ë¦¬_ìƒì„±(í‚¤ì›Œë“œ_ë¦¬ìŠ¤íŠ¸):
    í† í°_ë¦¬ìŠ¤íŠ¸ = []
    for í‚¤ì›Œë“œ in í‚¤ì›Œë“œ_ë¦¬ìŠ¤íŠ¸:
        # í•œê¸€/ì˜ì–´/ìˆ«ì ê¸°ì¤€ ë‹¨ì–´ ì¶”ì¶œ
        ë‹¨ì–´ë“¤ = re.findall(r"[ê°€-í£a-zA-Z0-9]+", í‚¤ì›Œë“œ)
        í† í°_ë¦¬ìŠ¤íŠ¸.extend(ë‹¨ì–´ë“¤)

    # ì¤‘ë³µ ì œê±° ë° ì •ë ¬(optional)
    í† í°_ë¦¬ìŠ¤íŠ¸ = sorted(set(í† í°_ë¦¬ìŠ¤íŠ¸))

    # AND ì¿¼ë¦¬ ìƒì„±
    query = " ".join(í† í°_ë¦¬ìŠ¤íŠ¸)
    return query

# í‚¤ì›Œë“œ_ë¦¬ìŠ¤íŠ¸ = [
#     "ìš°ì›ì‹ êµ­íšŒì˜ì¥",
#     "ê¹€ë™ì—° ê²½ê¸°ì§€ì‚¬",
#     "ê°œí—Œ êµ­ë¯¼íˆ¬í‘œ"
# ]



def ê°€ì¥ì˜¤ë˜ëœ_ê¸°ì‚¬_ì—­ìˆœ(query, display=10):
    url = "https://openapi.naver.com/v1/search/news.json"
    headers = {
        "X-Naver-Client-Id": CLIENT_ID,
        "X-Naver-Client-Secret": CLIENT_SECRET
    }

    for start in reversed(range(1, 92, display)):  # 91 â†’ 1
        params = {
            "query": query,
            "display": display,
            "start": start,
            "sort": "date"
        }

        response = requests.get(url, headers=headers, params=params)
        data = response.json()
        items = data.get("items", [])

        if not items:
            continue  # ë‹¤ìŒ í˜ì´ì§€ë¡œ ë„˜ì–´ê°

        # ê°€ì¥ ì˜¤ë˜ëœ ê¸°ì‚¬ ì¶”ì¶œ (ì´ í˜ì´ì§€ì—ì„œë§Œ)
        ê°€ì¥ì˜¤ë˜ëœ_ì‹œê° = None
        ê°€ì¥ì˜¤ë˜ëœ_ê¸°ì‚¬ = None
        for item in items:
            try:
                pubDate = datetime.strptime(item["pubDate"], "%a, %d %b %Y %H:%M:%S +0900")
                ì œëª© = BeautifulSoup(item["title"], "html.parser").text
                ë§í¬ = item["link"]
                if (ê°€ì¥ì˜¤ë˜ëœ_ì‹œê° is None) or (pubDate < ê°€ì¥ì˜¤ë˜ëœ_ì‹œê°):
                    ê°€ì¥ì˜¤ë˜ëœ_ì‹œê° = pubDate
                    ê°€ì¥ì˜¤ë˜ëœ_ê¸°ì‚¬ = {
                        "ì‘ì„±ì‹œê°": pubDate,
                        "ê¸°ì‚¬_ì œëª©": ì œëª©,
                        "ê¸°ì‚¬_ë§í¬": ë§í¬
                    }
            except:
                continue

        if ê°€ì¥ì˜¤ë˜ëœ_ê¸°ì‚¬:
            return ê°€ì¥ì˜¤ë˜ëœ_ê¸°ì‚¬  # âœ… ê°€ì¥ ìµœê·¼ í˜ì´ì§€ì—ì„œ ê°€ì¥ ì˜¤ë˜ëœ ê¸°ì‚¬ ì°¾ìŒ

    print("âŒ ê´€ë ¨ëœ ê¸°ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    return None

if __name__ == "__main__":
    # âœ… ì‹¤í–‰
    í‚¤ì›Œë“œ_ë¦¬ìŠ¤íŠ¸ = ['ì‚°ë¶ˆ ëŒ€ì‘ ì¤‘ì•™ì§€ë°©ì•ˆì „ëŒ€ì²´ë²•ì›', 'ì¬ë‚œì•ˆì „íŠ¹ê¶Œì„¸', 'ê²½ë¶Â·ê²½ë‚¨ ì‚°ë¶ˆ']

    query = í‚¤ì›Œë“œ_AND_ì¿¼ë¦¬_ìƒì„±(í‚¤ì›Œë“œ_ë¦¬ìŠ¤íŠ¸)
    ê°€ì¥ì˜¤ë˜ëœ_ê¸°ì‚¬_ê²°ê³¼ = ê°€ì¥ì˜¤ë˜ëœ_ê¸°ì‚¬_ì—­ìˆœ(query)
    if ê°€ì¥ì˜¤ë˜ëœ_ê¸°ì‚¬_ê²°ê³¼:
        print("ğŸ“Œ ê°€ì¥ ì˜¤ë˜ëœ ê¸°ì‚¬")
        print("ğŸ•’ ì‘ì„± ì‹œê°:", ê°€ì¥ì˜¤ë˜ëœ_ê¸°ì‚¬_ê²°ê³¼["ì‘ì„±ì‹œê°"])
        print("ğŸ“° ì œëª©:", ê°€ì¥ì˜¤ë˜ëœ_ê¸°ì‚¬_ê²°ê³¼["ê¸°ì‚¬_ì œëª©"])
        print("ğŸ”— ë§í¬:", ê°€ì¥ì˜¤ë˜ëœ_ê¸°ì‚¬_ê²°ê³¼["ê¸°ì‚¬_ë§í¬"])
    else:
        print("âŒ ê´€ë ¨ ê¸°ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    
    
    
# from datetime import timedelta

# # ì˜ˆì‹œ ì…ë ¥
# ìœ„í—˜ë„ = 0.78
# ë‚´_ê¸°ì‚¬_ì‘ì„±ì‹œê° = datetime.strptime("2025-04-01 14:00:00", "%Y-%m-%d %H:%M:%S")  # ì´ë¶€ë¶„ì€ LLMì—ì„œ ê°€ì ¸ì˜¤ê¸°
# ìµœì´ˆ_ê¸°ì‚¬_ì‹œê° = ê°€ì¥ì˜¤ë˜ëœ_ê¸°ì‚¬_ê²°ê³¼["ì‘ì„±ì‹œê°"]
# ê³µì‹_ë³´ë„ìë£Œ_ì‹œê° = None  # ë˜ëŠ” datetime ê°ì²´ë¡œ ì§€ì • #ì´ë¶€ë¶„ì€ RAGê°€ì ¸ì˜¬ë•Œ Chromaì—ì„œ ë½‘ì•„ì˜¤ê¸°

# # âœ… ê¸°ì¤€ ì‹œê° ì„¤ì •
# if ê³µì‹_ë³´ë„ìë£Œ_ì‹œê°:
#     ê¸°ì¤€ì‹œê° = ê³µì‹_ë³´ë„ìë£Œ_ì‹œê°
# elif ìµœì´ˆ_ê¸°ì‚¬_ì‹œê°:
#     ê¸°ì¤€ì‹œê° = ìµœì´ˆ_ê¸°ì‚¬_ì‹œê°
# else:
#     ê¸°ì¤€ì‹œê° = None  # ì´ìŠˆ ì‹œì  ë¯¸ì •

# # âœ… ì´ìŠˆ ì§í›„ ì—¬ë¶€ íŒë‹¨ (ì˜ˆ: ê¸°ì¤€ì‹œê° Â± 1ì‹œê°„ ì•ˆì´ë©´ ì§í›„ë¡œ ê°„ì£¼)
# ìµœì´ˆ_í™•ì‚°_ì‹œì  = "íŒë‹¨ë¶ˆê°€"
# if ê¸°ì¤€ì‹œê°:
#     if abs((ë‚´_ê¸°ì‚¬_ì‘ì„±ì‹œê° - ê¸°ì¤€ì‹œê°).total_seconds()) <= 3600:
#         ìµœì´ˆ_í™•ì‚°_ì‹œì  = "ì´ìŠˆ ì§í›„"
#     else:
#         ìµœì´ˆ_í™•ì‚°_ì‹œì  = "ì‹œê°„ ì°¨ì´ ì¡´ì¬"

# # âœ… ìœ„í—˜ë„ ë³´ì •
# if ìœ„í—˜ë„ > 0.7 and ìµœì´ˆ_í™•ì‚°_ì‹œì  == "ì´ìŠˆ ì§í›„":
#     ìœ„í—˜ë„ += 0.05  # ë³´ì¡° ì ìˆ˜ ì¶”ê°€

# # âœ… ì¶œë ¥ ê²°ê³¼ í™•ì¸
# print(f"ğŸ§  ê¸°ì¤€ì‹œê°: {ê¸°ì¤€ì‹œê°}")
# print(f"ğŸ“Œ ìµœì´ˆ í™•ì‚° ì‹œì : {ìµœì´ˆ_í™•ì‚°_ì‹œì }")
# print(f"âš ï¸ ìµœì¢… ìœ„í—˜ë„: {ìœ„í—˜ë„:.2f}")